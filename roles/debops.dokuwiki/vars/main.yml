---

# Configuration for php5-fpm pool
dokuwiki_php5_pool:
  enabled: True
  name: 'dokuwiki'
  user: '{{ dokuwiki_user }}'
  group: '{{ dokuwiki_group }}'

  php_admin_value:
    post_max_size:       '{{ dokuwiki_max_file_size }}M'
    upload_max_filesize: '{{ dokuwiki_max_file_size }}M'

# nginx configuration - PHP5 upstream
dokuwiki_nginx_upstream_php5:
  enabled: True
  name: 'php5_dokuwiki'
  type: 'php5'
  php5: 'dokuwiki'

# nginx configuration - DokuWiki server
dokuwiki_nginx_server:
  by_role: 'debops.dokuwiki'
  enabled: True
  type: 'php5'
  filename: '{{ dokuwiki_nginx_filename }}'
  name: '{{ dokuwiki_domains }}'
  root: '{{ dokuwiki_git_checkout }}'
  access_policy: '{{ dokuwiki_nginx_access_policy }}'
  auth_basic_realm: '{{ dokuwiki_nginx_auth_realm }}'
  index: 'index.html index.htm index.php doku.php'

  options: |
    autoindex off;
    client_max_body_size {{ dokuwiki_max_file_size }}M;
    client_body_buffer_size 128k;

  location:
    '/': |
      try_files $uri $uri/ @dokuwiki;

    '@dokuwiki': |
      rewrite ^/_media/(.*)           /lib/exe/fetch.php?media=$1   last;
      rewrite ^/_detail/(.*)          /lib/exe/detail.php?media=$1  last;
      rewrite ^/_export/([^/]+)/(.*)  /doku.php?do=export_$1&id=$2  last;
      rewrite ^/(.*)                  /doku.php?id=$1               last;

    '~ ^/lib.*\.(gif|png|ico|jpg)$': |
      expires 31536000s;
      add_header Pragma "public";
      add_header Cache-Control "max-age=31536000, public, must-revalidate, proxy-revalidate";
      log_not_found off;

    '~ /(data|conf|bin|inc|install.php)/': |
      deny all;

  php5: 'php5_dokuwiki'
  php5_options: |
    fastcgi_intercept_errors        on;
    fastcgi_ignore_client_abort     off;
    fastcgi_connect_timeout         60;
    fastcgi_send_timeout            180;
    fastcgi_read_timeout            180;
    fastcgi_buffer_size             128k;
    fastcgi_buffers               4 256k;
    fastcgi_busy_buffers_size       256k;
    fastcgi_temp_file_write_size    256k;

